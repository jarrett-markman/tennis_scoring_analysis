---
title: "Measuring Scoring Systems in Tennis"
author: "Jarrett Markman"
date: "YYYY-MM-DD"
output: pdf_document
---

# Abstract

Still in development

\newpage

# First-Step Analysis

We can solve the probability of a server and a returner winning a deuce game using a Stochastic Process called **First-Step Analysis**. 

A **Markov Chain** is a stochastic model that describes a sequence of possible events in which the probability of each event is based on only the previous state within the chain. 

**First-Step Analysis** is a specific Markov process that can measure the likelihood of transitioning to each state within a Markov chain. 

For this **Markov chain** we have the following state space:

$$\mathbb{S} = \{Deuce,\; Advantage\;Server,\; Advantage\;Returner,\; Game\;Server,\; Game\;Returner\}$$

To calculate the probability of a server or a returner winning a deuce game we can apply **First-Step Analysis** with the function:

$$f(x) = P[Server\; Wins\; Deuce\; Game\;|\;X(0) = x]\; for\; all\; x\in\; \mathbb{S}$$

In order to calculate the probability of a single point the following assumptions will be made:

* Each point is i.i.d (independent and identically distributed)
* The past does not matter (how the game got to deuce)
* Player performance is independent of pressure
* Player ability is independent of pressure and other possible effects
* The possible outcomes for winning an individual point are: 

$$\mathbb{S} = \{Server,\; Returner\}$$
$$P[Server\; Wins\; a\; Point] = x\in[0, 1]$$
$$P[Returner\; Wins\; a\; Point] = 1 - P[Server\; Wins\; a\; Point]$$
$$\sum_{}\mathbb{S} = 1$$

# On the next page we can visualize this **Markov Chain** as:

Where x represents the likelihood of the server winning a point and 1 - x represents the likelihood of the returner winning a point. 

```{r, warning = FALSE, message = FALSE, echo = FALSE}
library(tidyverse)
library(DiagrammeR)
library(webshot)
```

```{r, echo = FALSE}
links <- data.frame(
    source=c("Deuce"),
    target=c("Advantage Server", "Advantage Returner", "Game Server", "Game Returner")
)
labels <- unique(c(links$source,links$target))
nodes <- data.frame (id = labels, label = labels)
graph <- create_graph() %>% 
  add_global_graph_attrs("layout", "dot", "graph") %>%
  add_global_graph_attrs("concentrate", "true", "graph") %>%
  add_nodes_from_table(
      table = nodes,
      label_col = label) %>% 
  add_edge(from = "Deuce", to = "Advantage Server") %>% 
  add_edge(to = "Deuce", from = "Advantage Server") %>%
  add_edge(from = "Deuce", to = "Advantage Returner") %>% 
  add_edge(to = "Deuce", from = "Advantage Returner") %>%
  add_edge(from = "Advantage Server", to = "Game Server") %>% 
  add_edge(from = "Advantage Returner", to = "Game Returner") %>%
  set_edge_attrs(
    edge_attr = "label",
    values = c("x", "1 - x", "1 - x", "x", "x", "1 - x")
  ) %>%
  select_nodes_by_id(nodes = 1:length(labels)) %>% 
  set_node_attrs(node_attr = "fixedsize", values = FALSE) %>% 
  set_node_attrs_ws(
      node_attr = shape,
      value = "rectangle") %>% 
  set_node_attrs_ws(
      node_attr = "color",
      value = "black"
  ) %>%
  set_node_attrs(
      node_attr = "fillcolor",
      value = "red"
  ) %>%
  clear_selection() 
render_graph(graph, width = 1000, height = 1000)
```

\newpage

As previously stated, **First-Step Analysis** is a specific Markov process that can measure the likelihood of transitioning to each state within a Markov chain. 

With this we can solve the probability of a player winning a game by applying **First-Step Analysis** and **f(x)**.

## Note:

$$f(Game\;Server) = 1$$
$$f(Game\;Returner) = 0$$

**We are interested in calculating the probability of the server winning**.

We can calculate the likelihood of transferring between states of the Markov chain.

$$f(Deuce) = xf(Advantage\;Server)\;+\;(1-x)f(Advantage\;Returner)$$
$$f(Advantage\;Server) = (1-x)f(Deuce)\;+\;xf(Game\;Server)$$
$$f(Advantage\;Returner) = xf(Deuce)\;+\;(1-x)f(Game\;Returner)$$
We can create a transition matrix with:

$$\mathbb{S} = \{Deuce,\; Advantage\;Server,\; Advantage\;Returner,\; Game\;Server,\; Game\;Returner\}$$ 

in that order. 

$$\begin{bmatrix}
0 & x & 1-x & 0 & 0\\
1-x & 0 & 0 & x & 0\\
x & 0 & 0 & 0 & 1-x\\
0 & 0 & 0 & 1 & 0\\
0 & 0 & 0 & 0 & 1
\end{bmatrix}$$

**More importantly**, we can calculate the probability of both players winning a game for any point win probability with the following system of equations:

$$\begin{array}{lcl} f(Deuce)-xf(Advantage\;Server) - (1-x)f(Advantage\;Returner)=0\\ 
f(Advantage\;Server) - (1-x)f(Deuce)= x \\
f(Advantage\;Returner) - xf(Deuce)=0 \end{array}$$

\newpage

# The following plot displays the probability of winning a game with one deuce point, and the probability of winning a game with ad-scoring. 

```{r, echo = FALSE, warning = FALSE}
# Define the function
calculate_system <- function(x) {
    # Check if all elements of x are within the range [0, 1]
    if (all(x >= 0) && all(x <= 1)) {
        # Calculate y based on the relation y = 1 - x
        y <- 1 - x
        
        # Coefficients matrix
        A <- matrix(c(1, -x, -y, 0, 1, -y, -x, 0, 1), nrow = 3, byrow = TRUE)
        
        # Constants vector
        B <- c(0, x, 0)
        
        # Solve the system
        solution <- solve(A, B)
        
        # Return the solution for f(deuce)
        return(solution[1])
    } else {
        stop("Invalid input. Please provide values within the range of 0 and 1")
    }
}
# Create a data frame to store results
res <- data.frame(serve_win_prob = 1:100/100, prob = NA) %>%
  mutate(x_axis = serve_win_prob)
# Apply the calculate_system function to each serve_win_prob value
res$prob <- map_dbl(res$serve_win_prob, calculate_system)
# Find the point of intersection 
intersection_point <- res %>% arrange(desc(prob)) %>% tail(-1) %>% 
  mutate(min = abs(serve_win_prob-prob)) %>%
  arrange(min) %>% select(1) %>% head(1)[1]
# Plot the results
ggplot(res, aes(x = serve_win_prob)) +
  geom_line(aes(y = serve_win_prob, color = "Game Win Probability (no-ad)")) +
  geom_line(aes(y = prob, color = "Game Win Probability (ad)")) +
  # Add an intersecting line
  geom_hline(yintercept = intersection_point, linetype = "dashed", color = "black") +
  annotate("text", x = .25, y = .75, 
           label = glue::glue("Above this point of intersection, ad-scoring favors the server"), 
           vjust = -0.5, size = 2) +
  geom_segment(aes(x = intersection_point, y = intersection_point,
               xend = .25, yend = .75), color = "black") +
  labs(title = "Game Win Probabilities by Scoring System", 
       x = "Serve Win Probability", y = "Probability",
       color = "", caption = "Jarrett Markman") +
  theme_bw() +
  theme(plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
        legend.position = "top")
```
